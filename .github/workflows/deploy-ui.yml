name: Deploy UI to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v3

      - name: üîß Setup Node.js (22.12.0 for Wasp)
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
          check-latest: true

      - name: ‚öôÔ∏è Setup Wasp CLI
        run: |
          curl -sSL https://get.wasp.sh/installer.sh | bash
          echo "$HOME/.wasp/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.wasp/bin:$PATH"

      - name: üß™ Verify versions
        run: |
          node -v
          npm -v
          wasp version || true

      - name: üì¶ Install root deps and Rollup native binary
        run: |
          rm -rf node_modules package-lock.json
          npm install
          npm install --save-optional @rollup/rollup-linux-x64-gnu

      # üõ† 1Ô∏è‚É£ Build Wasp backend + SDK (ignore TypeScript errors)
      - name: üõ† Build Wasp SDK
        run: |
          cd app
          wasp build || true  # ignore SDK TS errors, we patch after

      # ü©π 2Ô∏è‚É£ Patch the generated SDK (useAuth & auth-styles.css)
      - name: ü©π Patch generated Wasp SDK
        run: |
          cd app
          # Patch useAuth.ts (you already have this script)
          chmod +x ci-patch-useauth.cjs || true
          node ci-patch-useauth.cjs || true
          echo "‚úÖ Patched useAuth.ts after SDK build"

          # Ensure missing auth-styles.css exists
          node ci-patch-auth-styles.cjs
          echo "‚úÖ Ensured auth-styles.css exists in Wasp SDK"

      # üßµ 2Ô∏è‚É£.5 Copy Tailwind & PostCSS config into web-app (fix Tailwind warning)
      - name: üßµ Copy Tailwind/PostCSS config into web-app
        run: |
          cd app
          cp tailwind.config.cjs .wasp/build/web-app/tailwind.config.cjs || true
          cp postcss.config.cjs .wasp/build/web-app/postcss.config.cjs || true
          echo "‚úÖ Tailwind + PostCSS configs copied into web-app"

      # üß± 3Ô∏è‚É£ Build frontend (no SDK rebuild now)
      - name: üé® Build frontend UI
        run: |
          cd app/.wasp/build/web-app
          rm -rf node_modules package-lock.json
          npm install
          npm install --save-optional @rollup/rollup-linux-x64-gnu
          sed -i 's|../../../index.html|index.html|' vite.config.ts || true
          npm run build
          echo "‚úÖ Frontend build complete"
          ls -la build/

      - name: üîê Write EC2 SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY_B64 }}" | base64 -d > ec2-key.pem
          chmod 600 ec2-key.pem

      - name: üì§ Copy UI build to EC2
        run: |
          HOST="${{ secrets.EC2_HOST }}"
          ssh -i ec2-key.pem -o StrictHostKeyChecking=no ubuntu@"$HOST" "rm -rf /home/ubuntu/frontend-temp && mkdir -p /home/ubuntu/frontend-temp"
          scp -i ec2-key.pem -o StrictHostKeyChecking=no -r app/.wasp/build/web-app/build/* ubuntu@"$HOST":/home/ubuntu/frontend-temp/

      - name: üöÄ Deploy UI to Nginx (NO-CACHE)
        run: |
          HOST="${{ secrets.EC2_HOST }}"
          ssh -i ec2-key.pem -o StrictHostKeyChecking=no ubuntu@"$HOST" << 'EOF'
            set -e
            echo "‚úÖ Cleaning /var/www/html"
            sudo rm -rf /var/www/html/*
            sudo mkdir -p /var/www/html

            echo "üì¶ Copying build to /var/www/html"
            sudo cp -r /home/ubuntu/frontend-temp/. /var/www/html/

            sudo chown -R www-data:www-data /var/www/html
            sudo find /var/www/html -type d -exec chmod 755 {} \;
            sudo find /var/www/html -type f -exec chmod 644 {} \;

            echo "üìù Creating nginx configuration"
            sudo tee /etc/nginx/sites-available/default > /dev/null <<'NGINXCONF'
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;
    
    root /var/www/html;
    index index.html index.htm;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    location / {
        try_files $uri $uri/ /index.html;
        
        # No-cache headers for SPA
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        expires off;
        etag off;
    }
    
    # Cache static assets (if any outside the build)
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1h;
        add_header Cache-Control "public, immutable";
    }
    
    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }
}
NGINXCONF

            echo "üß™ Testing nginx configuration"
            if ! sudo nginx -t; then
                echo "‚ùå Nginx configuration test failed!"
                sudo nginx -t 2>&1
                exit 1
            fi

            echo "üîÑ Reloading/Restarting nginx"
            # Try reload first, if it fails, force restart
            if sudo systemctl is-active --quiet nginx; then
                if sudo systemctl reload nginx; then
                    echo "‚úÖ Nginx reloaded successfully"
                else
                    echo "‚ö†Ô∏è Reload failed, attempting restart..."
                    sudo systemctl stop nginx || true
                    sleep 2
                    sudo systemctl start nginx
                    echo "‚úÖ Nginx restarted"
                fi
            else
                echo "‚ö†Ô∏è Nginx not running, starting fresh..."
                sudo systemctl stop nginx || true
                sleep 2
                sudo systemctl start nginx
                echo "‚úÖ Nginx started"
            fi

            # Verify nginx is running
            if sudo systemctl is-active --quiet nginx; then
                echo "‚úÖ Nginx is running"
                sudo systemctl status nginx --no-pager -l
            else
                echo "‚ùå Nginx failed to start!"
                sudo journalctl -xeu nginx.service --no-pager -n 50
                exit 1
            fi

            ls -la /var/www/html
            echo "üéâ UI deployed successfully (no-cache)"
          EOF

      - name: üßπ Clean up SSH key
        if: always()
        run: rm -f ec2-key.pem
